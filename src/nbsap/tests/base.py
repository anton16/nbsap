from django.db.models import Model

from django_webtest import WebTest
from webtest.forms import Select, MultipleSelect


class BaseWebTest(WebTest):

    def populate_fields(self, form, data):
        for field_name, field in form.field_order:
            if field_name in data:
                value = data[field_name]
                if isinstance(value, Model):
                    value = value.pk
                if isinstance(field, MultipleSelect):
                    if not isinstance(value, list):
                        value = [value]
                if isinstance(field, (Select, MultipleSelect)):
                    field.force_value(value)
                else:
                    field.value = value
        return form

    def normalize_data(self, data):
        for k, v in data.items():
            if isinstance(v, Model):
                data[k] = v.pk
        return data
